FROM twdps/circleci-remote-docker:slim-2021.08

LABEL maintainer=<nchenewe@thoughtworks.com>

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-exo", "pipefail", "-c"]

# hadolint ignore=DL4001,DL3004,DL3047
RUN echo 'APT::Get::Assume-Yes "true";' > /etc/apt/apt.conf.d/90circleci && \
    echo 'DPkg::Options "--force-confnew";' >> /etc/apt/apt.conf.d/90circleci && \
    echo "deb [trusted=yes] https://apt.secrethub.io stable main" > /etc/apt/sources.list.d/secrethub.sources.list && apt-get update && \
    apt-get install --no-install-recommends -y \
            sudo=1.9.5p2-3 \
            locales=2.31-13 \
            secrethub-cli=0.43.0 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    sed -i 's/^# *\(en_US.UTF-8\)/\1/' /etc/locale.gen && locale-gen && \
    useradd --uid=3434 --user-group --create-home circleci && usermod --shell /bin/bash circleci && \
    echo 'circleci ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers && \
    sudo -u circleci mkdir /home/circleci/project

ENV PATH=/home/circleci/bin:/home/circleci/.local/bin:$PATH \
	 LANG=en_US.UTF-8 \
	 LANGUAGE=en_US:en \
	 LC_ALL=en_US.UTF-8

USER circleci

WORKDIR /home/circleci/project
